<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Werwolf Webspiel</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 400px;
            margin: auto;
            background-color: #f8f9fa;
            color: #333;
            transition: background 0.5s, color 0.5s;
        }

        /* Tag/Nacht Phasen */
        .day-phase {
            background-color: #f8f9fa;
            color: #333;
            position: relative;
        }
        .day-phase::before {
            content: "‚òÄÔ∏è";
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 24px;
        }
        .night-phase {
            background-color: #121212;
            color: #ddd;
            position: relative;
        }
        .night-phase::before {
            content: "üåô";
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 24px;
        }

        /* Spielelemente */
        #menu, #game, #roleDisplay, #nightPhase, #dayPhase, #deathAnnouncement, #winAnimation, #ripScreen {
            display: none;
            margin-top: 20px;
        }
        #menu { display: block; }

        /* Rollen-Farben */
        .role-wolf {
            color: #b30000;
        }
        .role-villager {
            color: #00bfff;
        }
        .night-phase .role-wolf,
        .night-phase .role-villager {
            color: #fff;
        }

        /* Animationen */
        .animate-text {
            opacity: 0;
            transition: opacity 0.3s;
        }
        .animate-text.visible {
            opacity: 1;
        }

        /* Voting-Elemente */
        .vote-btn {
            display: block;
            width: 100%;
            margin: 5px 0;
            text-align: left;
            transition: background-color 0.3s;
        }
        .vote-btn.selected {
            background-color: #dc3545;
            color: white;
        }
        .vote-btn.targeted {
            background-color: #ffc107;
            color: black;
        }

        /* Wolf-Opfer-Buttons im Nachtmodus */
        .wolf-target-btn {
            color: #ff5555 !important;
            border-color: #ff5555;
        }
        .wolf-target-btn:hover {
            background-color: rgba(255, 85, 85, 0.2);
        }
        .wolf-target-btn.selected {
            background-color: #dc3545;
            color: white !important;
        }

        /* Gewinn-Animationen */
        #winAnimation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: none;
        }

        /* Blut-Animation f√ºr Werwolf-Sieg */
        .blood-animation {
            background-color: rgba(180, 0, 0, 0.1);
            animation: bloodPulse 3s ease-in-out forwards;
        }
        .blood-splash {
            position: absolute;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><path fill="rgba(180,0,0,0.7)" d="M50 0 C70 25 90 40 85 65 C80 85 65 95 50 100 C35 95 20 85 15 65 C10 40 30 25 50 0"></path></svg>');
            background-size: contain;
            background-repeat: no-repeat;
            width: 100px;
            height: 100px;
            opacity: 0;
            transform: scale(0);
        }
        @keyframes bloodPulse {
            0% { background-color: rgba(180, 0, 0, 0.1); }
            50% { background-color: rgba(180, 0, 0, 0.3); }
            100% { background-color: rgba(180, 0, 0, 0.1); }
        }
        @keyframes bloodSplash {
            0% { opacity: 0; transform: scale(0); }
            80% { opacity: 0.8; transform: scale(1); }
            100% { opacity: 0.6; transform: scale(0.9); }
        }

        /* Konfetti f√ºr Dorfbewohner-Sieg */
        .confetti-container {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            overflow: hidden;
        }
        .confetti {
            width: 10px;
            height: 10px;
            position: absolute;
            background-color: #f0f;
            opacity: 0;
        }

        /* RIP Screen */
        #ripScreen {
            background-color: #222;
            color: white;
            text-align: center;
            padding: 2rem;
        }
        .rip-icon {
            font-size: 5rem;
            margin-bottom: 1rem;
        }

        /* Chat f√ºr tote Spieler */
        #deadChat {
            background-color: rgba(0, 0, 0, 0.8);
            border-radius: 5px;
            padding: 10px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .chat-message {
            margin-bottom: 8px;
            padding: 5px;
            border-radius: 3px;
        }

        .chat-message .sender {
            font-weight: bold;
            color: #9a9aff;
        }

        .chat-input {
            margin-top: 10px;
            display: flex;
        }

        .chat-input input {
            flex-grow: 1;
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid #444;
        }

        /* Skip-Button f√ºr Abstimmung */
        .skip-vote-btn {
            background-color: #6c757d;
            color: white;
            margin-top: 10px;
        }

        /* Verf√ºgbare R√§ume */
        .room-list-item {
            cursor: pointer;
            padding: 10px;
            margin-bottom: 5px;
            border-radius: 5px;
            transition: background-color 0.2s;
        }
        .room-list-item:hover {
            background-color: #f0f0f0;
        }

        @media (max-width: 600px) {
            body { padding: 10px; max-width: 100%; }
        }
    </style>
</head>
<body>
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">Werwolf Spiel</h2>
    <div id="gameStatus" class="badge bg-secondary">Warte auf Spielstart</div>
</div>

<div id="menu" class="card p-3 shadow-sm">
    <input id="name" class="form-control mb-2" placeholder="Dein Name" />
    <input id="room" class="form-control mb-2" placeholder="Raum ID" />

    <button class="btn btn-primary mt-2" onclick="joinRoom()">Raum beitreten</button>
    <hr />
    <label class="form-label mt-2">Anzahl Werw√∂lfe:</label>
    <select id="wolves" class="form-select">
        <option>1</option><option>2</option><option>3</option>
    </select>
    <label class="form-label mt-2">Max Spielerzahl:</label>
    <select id="maxPlayers" class="form-select">
        <option>5</option><option>6</option><option>7</option><option>8</option>
        <option>9</option><option>10</option><option>11</option><option>12</option>
        <option>13</option><option>14</option><option>15</option>
    </select>
    <button class="btn btn-success mt-2" onclick="createRoom()">Raum erstellen</button>

    <div class="mt-4">
        <h5>Verf√ºgbare R√§ume:</h5>
        <div id="availableRooms" class="mt-2">
            <div class="text-center py-2">
                <div class="spinner-border spinner-border-sm" role="status">
                    <span class="visually-hidden">Lade R√§ume...</span>
                </div>
                <span class="ms-2">Lade R√§ume...</span>
            </div>
        </div>
    </div>
</div>

<div id="game" class="card p-3 shadow-sm mt-3">
    <h3 id="waitingMessage">Warte auf Mitspieler...</h3>
    <p id="playerList"></p>
    <div class="progress mt-2">
        <div id="playerProgress" class="progress-bar" role="progressbar" style="width: 0%"></div>
    </div>
</div>

<div id="roleDisplay" class="card p-3 shadow-sm mt-3 text-center">
    <h3>Deine Rolle:</h3>
    <h2 id="roleText" class="fw-bold"></h2>
    <p id="roleDescription" class="mt-3"></p>
</div>

<div id="nightPhase" class="card p-3 shadow-sm mt-3 text-center">
    <h3 class="mb-4">Das Dorf schl√§ft ein...</h3>
    <!-- F√ºr Werw√∂lfe -->
    <div id="wolfVote" style="display: none;">
        <h4 class="text-danger mb-3">W√§hle dein Opfer:</h4>
        <div id="wolfVoteButtons" class="d-grid gap-2"></div>
        <p class="mt-3 fst-italic">Ihr m√ºsst euch auf ein Opfer einigen.</p>
    </div>
    <!-- F√ºr Dorfbewohner -->
    <div id="villagerNight">
        <p class="mb-4">Schlie√üe deine Augen und warte...</p>
        <div class="d-flex justify-content-center">
            <div class="spinner-border text-light" role="status">
                <span class="visually-hidden">Warten...</span>
            </div>
        </div>
    </div>
</div>

<div id="deathAnnouncement" class="card p-3 shadow-sm mt-3 text-center">
    <h3 id="deathText" class="animate-text">Gestorben ist...</h3>
    <h2 id="victimName" class="fw-bold animate-text mt-3"></h2>
</div>

<div id="dayPhase" class="card p-3 shadow-sm mt-3">
    <h3 class="text-center mb-4">Wer ist der Werwolf?</h3>
    <div id="dayVoteButtons" class="d-grid gap-2"></div>
    <button id="skipVoteBtn" class="btn btn-secondary skip-vote-btn">Abstimmung √ºberspringen</button>
    <div class="mt-3 text-center">
        <div id="votingTimer" class="badge bg-primary mb-2">Abstimmung: 60s</div>
        <button id="confirmVote" class="btn btn-danger" disabled>Stimme abgeben</button>
    </div>
</div>

<div id="ripScreen" class="card shadow-sm">
    <div class="rip-icon">‚ö∞Ô∏è</div>
    <h2>R.I.P.</h2>
    <p class="lead">Du bist leider tot.</p>
    <p class="mt-3">Du kannst das Spiel weiterhin verfolgen, aber nicht mehr teilnehmen.</p>
    <p class="text-danger mt-3">Tote k√∂nnen nicht mehr zur√ºckkehren...</p>

    <!-- Chat f√ºr tote Spieler -->
    <div class="mt-4">
        <h4>Geisterfl√ºstern</h4>
        <p class="text-muted small">Nur andere tote Spieler k√∂nnen dich h√∂ren...</p>
        <div id="deadChat"></div>
        <div class="chat-input">
            <input type="text" id="chatInput" class="form-control" placeholder="Nachricht schreiben..." />
            <button class="btn btn-outline-light ms-2" onclick="sendDeadChat()">‚Üë</button>
        </div>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const socket = io();
    let name = "", room = "";
    let myRole = "";
    let alivePlayers = [];
    let myVote = null;
    let wolfTarget = null;
    let maxPlayersInRoom = 0;
    let readyForNextGame = false;
    let amIDead = false;

    // Initialisiere Chat-Nachrichten
    let deadChatMessages = [];

    // Beim Laden verf√ºgbare R√§ume abrufen
    fetchAvailableRooms();

    // Periodisch Raumliste aktualisieren
    setInterval(fetchAvailableRooms, 5000);

    function fetchAvailableRooms() {
        socket.emit("getAvailableRooms");
    }

    socket.on("availableRooms", (rooms) => {
        const roomsContainer = document.getElementById("availableRooms");

        if (rooms.length === 0) {
            roomsContainer.innerHTML = '<p class="text-muted">Keine R√§ume verf√ºgbar</p>';
            return;
        }

        let roomsHtml = '';
        rooms.forEach(r => {
            roomsHtml += `
                <div class="room-list-item border" onclick="selectRoom('${r.id}')">
                    <div class="d-flex justify-content-between">
                        <span><b>${r.id}</b></span>
                        <span>üë• (${r.players}/${r.maxPlayers}) üê∫ [${r.wolves}]</span>
                    </div>
                </div>
            `;
        });

        roomsContainer.innerHTML = roomsHtml;
    });

    function selectRoom(roomId) {
        document.getElementById("room").value = roomId;
    }

    function createRoom() {
        name = document.getElementById("name").value;
        room = document.getElementById("room").value;
        const wolves = parseInt(document.getElementById("wolves").value);
        const maxPlayers = parseInt(document.getElementById("maxPlayers").value);
        maxPlayersInRoom = maxPlayers;

        if (!name || !room) return alert("Name und Raum-ID eingeben!");
        socket.emit("createRoom", { name, room, wolves, maxPlayers });
        document.getElementById("menu").style.display = "none";
        document.getElementById("game").style.display = "block";
        document.getElementById("gameStatus").textContent = "Lobby";
    }

    function joinRoom() {
        name = document.getElementById("name").value;
        room = document.getElementById("room").value;

        if (!name || !room) return alert("Name und Raum-ID eingeben!");
        socket.emit("joinRoom", { name, room });
        document.getElementById("menu").style.display = "none";
        document.getElementById("game").style.display = "block";
        document.getElementById("gameStatus").textContent = "Lobby";
    }

    socket.on("roomInfo", (roomInfo) => {
        maxPlayersInRoom = roomInfo.maxPlayers;
        updateWaitingMessage(roomInfo.players.length);
    });

    socket.on("updatePlayerList", (players) => {
        const playerList = document.getElementById("playerList");
        playerList.textContent = players.map(p => p.name).join(", ");

        // Spielerliste f√ºr sp√§tere Verwendung speichern
        alivePlayers = players;

        // Wartenachricht und Fortschrittsbalken aktualisieren
        updateWaitingMessage(players.length);
        const progress = (players.length / maxPlayersInRoom) * 100;
        document.getElementById("playerProgress").style.width = `${progress}%`;
    });

    function updateWaitingMessage(currentPlayers) {
        const waitingMessage = document.getElementById("waitingMessage");
        const playersNeeded = maxPlayersInRoom - currentPlayers;

        if (playersNeeded > 0) {
            waitingMessage.textContent = `Warte auf ${playersNeeded} weitere Spieler...`;
        } else if (readyForNextGame) {
            waitingMessage.textContent = `Bereit f√ºr n√§chste Runde...`;
        } else {
            waitingMessage.textContent = `Spiel startet in K√ºrze!`;
        }
    }

    // Animierte Rollenzuweisung
    socket.on("showRole", (role) => {
        // Alle Ansichten verstecken, au√üer RIP-Bildschirm falls tot
        if (amIDead) return;

        document.getElementById("game").style.display = "none";
        document.getElementById("roleDisplay").style.display = "block";
        document.getElementById("gameStatus").textContent = "Rollenverteilung";
        readyForNextGame = false;

        const roleText = document.getElementById("roleText");
        roleText.textContent = "";
        roleText.className = "fw-bold animate-text";
        myRole = role;

        // Animation: "Du..." -> "Du... bist..." -> "Du... bist... [Rolle]"
        let steps = [
            "Du...",
            "Du... bist...",
            `Du... bist... ${role === "Werwolf" ? "Werwolf" : "Dorfbewohner"}`
        ];
        let i = 0;
        function showStep() {
            roleText.textContent = steps[i];
            roleText.classList.add("visible");
            setRoleColor(role);
            if (i < steps.length - 1) {
                setTimeout(() => {
                    roleText.classList.remove("visible");
                    setTimeout(() => {
                        i++;
                        showStep();
                    }, 300);
                }, 1000);
            } else {
                // Nach Animation: Rolle dauerhaft anzeigen
                setTimeout(() => {
                    roleText.textContent = role;
                    setRoleColor(role);
                    roleText.className = "fw-bold";

                    // Rollenbeschreibung anzeigen
                    const desc = document.getElementById("roleDescription");
                    if (role === "Werwolf") {
                        desc.textContent = "Deine Aufgabe: W√§hle nachts mit den anderen Werw√∂lfen ein Opfer. Verberge tags√ºber deine Identit√§t.";
                    } else {
                        desc.textContent = "Deine Aufgabe: Finde heraus, wer die Werw√∂lfe sind und stimme bei Tag gegen sie ab.";
                    }
                }, 1000);
            }
        }
        showStep();
    });

    function setRoleColor(role) {
        const roleText = document.getElementById('roleText');
        if (role === "Werwolf") {
            roleText.classList.add("role-wolf");
            roleText.classList.remove("role-villager");
        } else {
            roleText.classList.add("role-villager");
            roleText.classList.remove("role-wolf");
        }
    }

    // Nachtphase starten
    socket.on("startNight", () => {
        // Tote Spieler sehen nur den RIP-Bildschirm
        if (amIDead) return;

        document.getElementById("roleDisplay").style.display = "none";
        document.getElementById("dayPhase").style.display = "none";
        document.getElementById("nightPhase").style.display = "block";
        document.getElementById("gameStatus").textContent = "Nacht";
        document.body.classList.add("night-phase");
        document.body.classList.remove("day-phase");

        // Werwolf-Voting vorbereiten
        if (myRole === "Werwolf") {
            document.getElementById("wolfVote").style.display = "block";
            document.getElementById("villagerNight").style.display = "none";

            // Voting-Buttons erstellen
            const wolfVoteButtons = document.getElementById("wolfVoteButtons");
            wolfVoteButtons.innerHTML = "";

            // Nur lebende Dorfbewohner als potenzielle Opfer anzeigen
            const livingVictims = alivePlayers.filter(player =>
                player.id !== socket.id && // Sich selbst nicht anzeigen
                player.role !== "Werwolf" &&
                player.alive);

            if (livingVictims.length === 0) {
                wolfVoteButtons.innerHTML = `
                    <div class="alert alert-warning">
                        Keine Dorfbewohner mehr √ºbrig!
                    </div>`;
            } else {
                livingVictims.forEach(player => {
                    const btn = document.createElement("button");
                    btn.className = "btn btn-outline-light vote-btn wolf-target-btn";
                    btn.textContent = player.name;
                    btn.dataset.player = player.id;
                    btn.onclick = function() {
                        // Alle Buttons zur√ºcksetzen
                        document.querySelectorAll(".vote-btn").forEach(b =>
                            b.classList.remove("selected"));
                        // Diesen Button ausw√§hlen
                        this.classList.add("selected");
                        // Vote an Server senden
                        wolfTarget = player.id;
                        socket.emit("wolfVote", { room, target: player.id });
                    };
                    wolfVoteButtons.appendChild(btn);
                });
            }
        } else {
            document.getElementById("wolfVote").style.display = "none";
            document.getElementById("villagerNight").style.display = "block";
        }
    });

    // Werwolf-Votes aktualisieren (f√ºr alle Werw√∂lfe)
    socket.on("updateWolfVotes", (votes) => {
        if (myRole !== "Werwolf" || amIDead) return;

        // Alle Buttons zur√ºcksetzen
        document.querySelectorAll(".vote-btn").forEach(btn =>
            btn.classList.remove("targeted"));

        // Anzeigen, welche Spieler von anderen Werw√∂lfen anvisiert werden
        for (const [wolfId, targetId] of Object.entries(votes)) {
            if (wolfId !== socket.id) { // Nicht meine eigene Stimme
                const targetBtn = document.querySelector(`.vote-btn[data-player="${targetId}"]`);
                if (targetBtn) targetBtn.classList.add("targeted");
            }
        }
    });

    // Tod-Ank√ºndigung
    socket.on("announceVictim", (victim) => {
        // Auch tote Spieler sehen die Ank√ºndigung, k√∂nnen aber nicht mehr abstimmen
        if (amIDead) return;

        document.getElementById("nightPhase").style.display = "none";
        document.getElementById("deathAnnouncement").style.display = "block";
        document.getElementById("gameStatus").textContent = "Morgengrauen";

        const deathText = document.getElementById("deathText");
        const victimName = document.getElementById("victimName");

        deathText.textContent = "Gestorben ist...";
        victimName.textContent = "";
        deathText.classList.add("visible");
        victimName.classList.remove("visible");

        // Nach einer Sekunde den Namen anzeigen
        setTimeout(() => {
            victimName.textContent = victim.name;
            victimName.classList.add("visible");

            // Nach weiteren 3 Sekunden zur Tagphase √ºbergehen
            setTimeout(() => {
                // Wenn ich das Opfer bin, zeige RIP-Bildschirm
                if (victim.id === socket.id) {
                    showRipScreen();
                } else {
                    socket.emit("readyForDay", { room });
                }
            }, 3000);
        }, 1000);
    });

    // RIP-Bildschirm anzeigen f√ºr tote Spieler
    function showRipScreen() {
        // Alle Spielansichten ausblenden
        document.querySelectorAll("#game, #roleDisplay, #nightPhase, #dayPhase, #deathAnnouncement").forEach(el => {
            el.style.display = "none";
        });

        // RIP-Bildschirm anzeigen
        document.getElementById("ripScreen").style.display = "block";
        document.getElementById("gameStatus").textContent = "Verstorben";
        amIDead = true;

        // Toten-Chat initialisieren
        document.getElementById("deadChat").innerHTML = "";

        // Chat-Event-Listener hinzuf√ºgen (nur einmal)
        if (!document.getElementById("chatInput").hasAttribute("data-listener-added")) {
            document.getElementById("chatInput").addEventListener("keyup", function(event) {
                if (event.key === "Enter") {
                    sendDeadChat();
                }
            });
            document.getElementById("chatInput").setAttribute("data-listener-added", "true");
        }
    }

    // Chat-Nachricht senden
    function sendDeadChat() {
        const input = document.getElementById("chatInput");
        const message = input.value.trim();

        if (message) {
            socket.emit("deadChat", { room, name, message });
            input.value = "";

            // Lokale Chat-Vorschau anzeigen (optionales Feedback)
            const chatMessage = { name, message, timestamp: Date.now(), isMe: true };
            deadChatMessages.push(chatMessage);
            updateDeadChat();
        }
    }

    // Chat aktualisieren
    function updateDeadChat() {
        const chatContainer = document.getElementById("deadChat");
        let chatHtml = "";

        if (deadChatMessages.length === 0) {
            chatHtml = '<div class="text-muted">Noch keine Nachrichten. Sei der Erste, der ins Jenseits spricht!</div>';
        } else {
            deadChatMessages.forEach(msg => {
                const isMe = msg.isMe ? 'text-info' : '';
                chatHtml += `
                    <div class="chat-message">
                        <span class="sender ${isMe}">${msg.name}:</span> ${msg.message}
                    </div>
                `;
            });
        }

        chatContainer.innerHTML = chatHtml;
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // Neue Chat-Nachricht erhalten
    socket.on("deadChatMessage", (msg) => {
        // Nur Nachrichten empfangen, wenn man tot ist
        if (!amIDead) return;

        deadChatMessages.push(msg);
        updateDeadChat();
    });

    // Tagphase starten
    socket.on("startDay", (data) => {
        // Tote Spieler sehen nur den RIP-Bildschirm
        if (amIDead) return;

        document.getElementById("deathAnnouncement").style.display = "none";
        document.getElementById("dayPhase").style.display = "block";
        document.getElementById("gameStatus").textContent = "Tag";
        document.body.classList.remove("night-phase");
        document.body.classList.add("day-phase");

        // Abstimmungs-Status zur√ºcksetzen
        myVote = null;
        document.getElementById("confirmVote").disabled = true;
        document.getElementById("confirmVote").textContent = "Stimme abgeben";
        document.getElementById("skipVoteBtn").classList.remove("selected");
        document.getElementById("skipVoteBtn").disabled = false;

        // Voting-Buttons erstellen
        const dayVoteButtons = document.getElementById("dayVoteButtons");
        dayVoteButtons.innerHTML = "";

        // Nur lebende Spieler in der Abstimmungsliste anzeigen
        // Aktualisieren der alivePlayers mit den vom Server gesendeten Daten
        if (data && data.alivePlayers) {
            alivePlayers = data.alivePlayers;
        }

        const livingPlayers = alivePlayers.filter(player =>
            player.id !== socket.id && // Sich selbst ausschlie√üen
            player.alive);

        if (livingPlayers.length <= 1) {
            dayVoteButtons.innerHTML = `
                <div class="alert alert-warning">
                    Nicht gen√ºgend Spieler f√ºr eine Abstimmung.
                </div>`;
            document.getElementById("skipVoteBtn").click(); // Automatisch Skip w√§hlen
        } else {
            livingPlayers.forEach(player => {
                const btn = document.createElement("button");
                btn.className = "btn btn-outline-dark vote-btn";
                btn.textContent = player.name;
                btn.dataset.player = player.id;
                btn.onclick = function() {
                    // Alle Buttons zur√ºcksetzen
                    document.querySelectorAll(".vote-btn").forEach(b =>
                        b.classList.remove("selected"));
                    document.getElementById("skipVoteBtn").classList.remove("selected");
                    // Diesen Button ausw√§hlen
                    this.classList.add("selected");
                    // Vote speichern
                    myVote = player.id;
                    // Abstimm-Button aktivieren
                    document.getElementById("confirmVote").disabled = false;
                };
                dayVoteButtons.appendChild(btn);
            });
        }

        // Skip-Button f√ºr Abstimmung
        document.getElementById("skipVoteBtn").onclick = function() {
            // Alle Buttons zur√ºcksetzen
            document.querySelectorAll(".vote-btn").forEach(b =>
                b.classList.remove("selected"));
            // Skip als Vote speichern
            myVote = "skip";
            // Abstimm-Button aktivieren
            document.getElementById("confirmVote").disabled = false;
            // Diesen Button hervorheben
            this.classList.add("selected");
        };

        // Abstimm-Button
        document.getElementById("confirmVote").onclick = function() {
            if (myVote) {
                socket.emit("dayVote", { room, target: myVote });
                this.disabled = true;
                this.textContent = "Stimme abgegeben";
                dayVoteButtons.querySelectorAll("button").forEach(btn => {
                    btn.disabled = true;
                });
                document.getElementById("skipVoteBtn").disabled = true;
            }
        };

        // Timer starten
        let timeLeft = 60;
        const timerElement = document.getElementById("votingTimer");
        const timer = setInterval(() => {
            timeLeft--;
            timerElement.textContent = `Abstimmung: ${timeLeft}s`;
            if (timeLeft <= 0) {
                clearInterval(timer);
                timerElement.textContent = "Abstimmung beendet";
                // Automatisch abstimmen, falls noch nicht getan
                if (!document.getElementById("confirmVote").disabled) {
                    // Automatisch Skip w√§hlen, wenn keine Auswahl getroffen wurde
                    if (!myVote) {
                        myVote = "skip";
                    }
                    document.getElementById("confirmVote").click();
                }
            }
        }, 1000);
    });

    // Niemand wurde get√∂tet Benachrichtigung
    socket.on("noElimination", () => {
        // Auch f√ºr tote Spieler anzeigen
        document.getElementById("nightPhase").style.display = "none";
        document.getElementById("dayPhase").style.display = "none";

        if (!amIDead) {
            document.getElementById("deathAnnouncement").style.display = "block";
        }

        document.getElementById("gameStatus").textContent = "Abstimmungsergebnis";

        const deathText = document.getElementById("deathText");
        const victimName = document.getElementById("victimName");

        deathText.textContent = "Das Ergebnis...";
        victimName.textContent = "";
        deathText.classList.add("visible");
        victimName.classList.remove("visible");

        // Nach einer Sekunde die Nachricht anzeigen
        setTimeout(() => {
            victimName.textContent = "Heute ist niemand gestorben...";
            victimName.classList.add("visible");

            // Nach weiteren 3 Sekunden weitergehen
            setTimeout(() => {
                if (!amIDead) {
                    socket.emit("readyForNight", { room });
                }
            }, 3000);
        }, 1000);
    });

    // Spielende
    socket.on("gameOver", (result) => {
        // Alle UI-Elemente ausblenden, au√üer ripScreen f√ºr tote Spieler
        document.getElementById("nightPhase").style.display = "none";
        document.getElementById("dayPhase").style.display = "none";
        document.getElementById("deathAnnouncement").style.display = "none";

        // Gewinn-Animation basierend auf Sieger, auch f√ºr tote Spieler
        playWinAnimation(result.winner);

        // Nach Animation Spielergebnisse anzeigen
        setTimeout(() => {
            // Auch f√ºr tote Spieler den RIP-Screen ausblenden
            if (amIDead) {
                document.getElementById("ripScreen").style.display = "none";
            }

            const gameDiv = document.getElementById("game");
            gameDiv.style.display = "block";
            gameDiv.innerHTML = `
                <h2 class="text-center mb-4">${result.winner} haben gewonnen!</h2>
                <div class="card p-3">
                    <h4>Spieler:</h4>
                    <ul class="list-group">
                        ${result.players.map(p => {
                            // Bestimmen, ob Spieler gewonnen hat
                            const hasWon = (p.role === "Werwolf" && result.winner === "Werw√∂lfe") ||
                                         (p.role === "Dorfbewohner" && result.winner === "Dorfbewohner");

                            return `
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    ${p.name}
                                    <span class="result-badge ${hasWon ? 'win-badge' : 'loss-badge'}">${hasWon ? 'W' : 'L'}</span>
                                </div>
                                <div>
                                    <span class="badge ${p.role === 'Werwolf' ? 'bg-danger' : 'bg-primary'}">${p.role}</span>
                                    ${p.alive ? '' : '<span class="badge bg-secondary ms-1">‚ò†Ô∏è Tot</span>'}
                                </div>
                            </li>`;
                        }).join('')}
                    </ul>
                </div>
                <div class="d-flex justify-content-between mt-3">
                    <button class="btn btn-primary flex-grow-1 me-2" onclick="playAgain()">Nochmal spielen</button>
                    <button class="btn btn-secondary flex-grow-1" onclick="location.reload()">Neues Spiel</button>
                </div>
            `;
            document.getElementById("gameStatus").textContent = "Spiel beendet";
        }, 3500);
    });

    function playAgain() {
        readyForNextGame = true;
        socket.emit("playAgain", { room, name });

        const gameDiv = document.getElementById("game");
        gameDiv.innerHTML = `
            <h3 id="waitingMessage">Warte auf weitere Spieler...</h3>
            <p id="playerList"></p>
            <div class="progress mt-2">
                <div id="playerProgress" class="progress-bar" role="progressbar" style="width: 0%"></div>
            </div>
            <button class="btn btn-secondary mt-3" onclick="leaveRoom()">Spiel verlassen</button>
        `;
        document.getElementById("gameStatus").textContent = "Lobby";
    }

    function leaveRoom() {
        location.reload();
    }

    function playWinAnimation(winner) {
        const animationContainer = document.getElementById("winAnimation");
        animationContainer.style.display = "block";

        if (winner === "Werw√∂lfe") {
            // Blutverschmierte Animation
            animationContainer.className = "blood-animation";

            // Blutflecken hinzuf√ºgen
            for (let i = 0; i < 10; i++) {
                const splash = document.createElement("div");
                splash.className = "blood-splash";

                // Zuf√§llige Position
                splash.style.left = `${Math.random() * 80 + 10}%`;
                splash.style.top = `${Math.random() * 80 + 10}%`;

                // Zuf√§llige Gr√∂√üe
                const size = Math.random() * 100 + 50;
                splash.style.width = `${size}px`;
                splash.style.height = `${size}px`;

                // Zuf√§llige Rotation
                splash.style.transform = `rotate(${Math.random() * 360}deg)`;

                // Animation mit Verz√∂gerung
                splash.style.animation = `bloodSplash 2s ease-out ${Math.random() * 1.5}s forwards`;

                animationContainer.appendChild(splash);
            }

            // Animation nach 3.5 Sekunden entfernen
            setTimeout(() => {
                animationContainer.style.display = "none";
                animationContainer.innerHTML = "";
                animationContainer.className = "";
            }, 3500);

        } else {
            // Konfetti-Animation f√ºr Dorfbewohner
            const confettiContainer = document.createElement("div");
            confettiContainer.className = "confetti-container";
            animationContainer.appendChild(confettiContainer);

            // 100 Konfetti-Teilchen erstellen
            for (let i = 0; i < 100; i++) {
                createConfetti(confettiContainer);
            }

            // Animation nach 3.5 Sekunden entfernen
            setTimeout(() => {
                animationContainer.style.display = "none";
                animationContainer.innerHTML = "";
            }, 3500);
        }
    }

    function createConfetti(container) {
        const confetti = document.createElement("div");
        confetti.className = "confetti";

        // Zuf√§llige Farbe
        const colors = ["#f94144", "#f3722c", "#f8961e", "#f9c74f", "#90be6d", "#43aa8b", "#577590", "#277da1"];
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];

        // Zuf√§llige Form
        if (Math.random() > 0.5) {
            confetti.style.borderRadius = "50%";
        }

        // Zuf√§llige Position
        const startLeft = Math.random() * 100;
        confetti.style.left = `${startLeft}%`;
        confetti.style.top = "-20px";

        // Animation mit CSS
        const duration = Math.random() * 3 + 2;
        const delay = Math.random() * 1;

        confetti.style.animation = `
            fallDown ${duration}s ease-in ${delay}s forwards,
            sideMovement ${duration * 0.5}s ease-in-out ${delay}s alternate infinite
        `;

        // Eigene Animation f√ºr fallende Konfetti
        const keyframes = `
            @keyframes fallDown {
                0% { transform: translateY(0) rotate(0deg); opacity: 1; }
                100% { transform: translateY(${window.innerHeight}px) rotate(360deg); opacity: 0; }
            }
            @keyframes sideMovement {
                0% { margin-left: -20px; }
                100% { margin-left: 20px; }
            }
        `;

        // F√ºge die Keyframes einmalig hinzu
        if (!document.querySelector('#confetti-keyframes')) {
            const style = document.createElement('style');
            style.id = 'confetti-keyframes';
            style.innerHTML = keyframes;
            document.head.appendChild(style);
        }

        container.appendChild(confetti);
    }

    socket.on("errorMessage", (msg) => {
        alert(msg);
        location.reload();
    });
</script>
</body>
</html>
