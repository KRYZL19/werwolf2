<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Werwolf Webspiel</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 400px;
            margin: auto;
            background-color: #f8f9fa;
            color: #333;
            transition: background 0.5s, color 0.5s;
        }

        /* Tag/Nacht Phasen */
        .day-phase {
            background-color: #f8f9fa;
            color: #333;
            position: relative;
        }
        .day-phase::before {
            content: "‚òÄÔ∏è";
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 24px;
        }
        .night-phase {
            background-color: #121212;
            color: #ddd;
            position: relative;
        }
        .night-phase::before {
            content: "üåô";
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 24px;
        }

        /* Spielelemente */
        #menu, #game, #roleDisplay, #nightPhase, #dayPhase, #deathAnnouncement, #winAnimation, #ripScreen {
            display: none;
            margin-top: 20px;
        }
        #menu { display: block; }

        /* Rollen-Farben */
        .role-wolf {
            color: #b30000;
        }
        .role-villager {
            color: #00bfff;
        }
        .night-phase .role-wolf,
        .night-phase .role-villager {
            color: #fff;
        }

        /* Animationen */
        .animate-text {
            opacity: 0;
            transition: opacity 0.3s;
        }
        .animate-text.visible {
            opacity: 1;
        }

        /* Voting-Elemente */
        .vote-btn {
            display: block;
            width: 100%;
            margin: 5px 0;
            text-align: left;
            transition: background-color 0.3s;
        }
        .vote-btn.selected {
            background-color: #dc3545;
            color: white;
        }
        .vote-btn.targeted {
            background-color: #ffc107;
            color: black;
        }

        /* Wolf-Opfer-Buttons im Nachtmodus */
        .wolf-target-btn {
            color: #ff5555 !important;
            border-color: #ff5555;
        }
        .wolf-target-btn:hover {
            background-color: rgba(255, 85, 85, 0.2);
        }
        .wolf-target-btn.selected {
            background-color: #dc3545;
            color: white !important;
        }

        /* Gewinn-Animationen */
        #winAnimation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: none;
        }

        /* Blut-Animation f√ºr Werwolf-Sieg */
        .blood-animation {
            background-color: rgba(180, 0, 0, 0.1);
            animation: bloodPulse 3s ease-in-out forwards;
        }
        .blood-splash {
            position: absolute;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><path fill="rgba(180,0,0,0.7)" d="M50 0 C70 25 90 40 85 65 C80 85 65 95 50 100 C35 95 20 85 15 65 C10 40 30 25 50 0"></path></svg>');
            background-size: contain;
            background-repeat: no-repeat;
            width: 100px;
            height: 100px;
            opacity: 0;
            transform: scale(0);
        }
        @keyframes bloodPulse {
            0% { background-color: rgba(180, 0, 0, 0.1); }
            50% { background-color: rgba(180, 0, 0, 0.3); }
            100% { background-color: rgba(180, 0, 0, 0.1); }
        }
        @keyframes bloodSplash {
            0% { opacity: 0; transform: scale(0); }
            80% { opacity: 0.8; transform: scale(1); }
            100% { opacity: 0.6; transform: scale(0.9); }
        }

        /* Konfetti f√ºr Dorfbewohner-Sieg */
        .confetti-container {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            overflow: hidden;
        }
        .confetti {
            width: 10px;
            height: 10px;
            position: absolute;
            background-color: #f0f;
            opacity: 0;
        }

        /* RIP Screen */
        #ripScreen {
            background-color: #222;
            color: white;
            text-align: center;
            padding: 2rem;
        }
        .rip-icon {
            font-size: 5rem;
            margin-bottom: 1rem;
        }

        /* Chat f√ºr tote Spieler */
        #deadChat {
            background-color: rgba(0, 0, 0, 0.8);
            border-radius: 5px;
            padding: 10px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .chat-message {
            margin-bottom: 8px;
            padding: 5px;
            border-radius: 3px;
        }

        .chat-message .sender {
            font-weight: bold;
            color: #9a9aff;
        }

        .chat-input {
            margin-top: 10px;
            display: flex;
        }

        .chat-input input {
            flex-grow: 1;
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid #444;
        }

        /* Skip-Button f√ºr Abstimmung */
        .skip-vote-btn {
            background-color: #6c757d;
            color: white;
            margin-top: 10px;
        }

        /* Verf√ºgbare R√§ume */
        .room-list-item {
            cursor: pointer;
            padding: 10px;
            margin-bottom: 5px;
            border-radius: 5px;
            transition: background-color 0.2s;
        }
        .room-list-item:hover {
            background-color: #f0f0f0;
        }

        /* Win/Loss Badge f√ºr Spielergebnis */
        .result-badge {
            display: inline-block;
            width: 24px;
            height: 24px;
            line-height: 24px;
            text-align: center;
            border-radius: 50%;
            font-weight: bold;
            margin-left: 5px;
        }
        .win-badge {
            border: 2px solid #28a745;
            color: #28a745;
            background-color: rgba(40, 167, 69, 0.1);
        }
        .loss-badge {
            border: 2px solid #dc3545;
            color: #dc3545;
            background-color: rgba(220, 53, 69, 0.1);
        }

        /* Verbesserte Spieler-Labels */
        .player-role-wolf {
            background-color: #dc3545;
        }
        .player-role-villager {
            background-color: #0d6efd;
        }
        .player-status-dead {
            background-color: #6c757d;
        }

        /* Ready-Button Styling */
        .ready-button {
            background-color: #28a745;
            color: white;
            transition: all 0.3s;
        }
        .ready-button:hover {
            background-color: #218838;
        }
        .ready-button.active {
            background-color: #1e7e34;
            box-shadow: 0 0 0 0.25rem rgba(40, 167, 69, 0.5);
        }

        /* Verbesserter Ergebnis-Screen */
        .result-card {
            border: none;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .result-card .card-header {
            font-weight: bold;
            font-size: 1.2rem;
        }
        .result-card .list-group-item {
            transition: all 0.2s;
        }
        .result-card .list-group-item:hover {
            background-color: #f8f9fa;
        }

        /* Verbesserte Animations-Darstellung */
        #winAnimation {
            z-index: 2000; /* H√∂herer z-index f√ºr bessere Sichtbarkeit */
        }

        /* Version Info */
        #versionInfo {
            position: fixed;
            bottom: 10px;
            right: 10px;
            font-size: 0.75rem;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            z-index: 100;
            max-width: 300px;
            overflow: hidden;
        }

        #versionInfo .toggle-details {
            cursor: pointer;
            text-decoration: underline;
        }

        #versionDetails {
            display: none;
            margin-top: 5px;
            font-size: 0.7rem;
            max-height: 150px;
            overflow-y: auto;
        }

        /* Verbesserte Siege-Animationen */
        #winAnimation {
            z-index: 2000;
        }

        /* Konfetti-Animation verbessern */
        @keyframes fallDown {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
        }

        @keyframes sideMovement {
            0% { margin-left: -20px; }
            100% { margin-left: 20px; }
        }

        @media (max-width: 600px) {
            body { padding: 10px; max-width: 100%; }
        }
    </style>
</head>
<body>
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">Werwolf Spiel</h2>
    <div id="gameStatus" class="badge bg-secondary">Warte auf Spielstart</div>
</div>

<div id="menu" class="card p-3 shadow-sm">
    <input id="name" class="form-control mb-2" placeholder="Dein Name" />
    <input id="room" class="form-control mb-2" placeholder="Raum ID" />

    <button class="btn btn-primary mt-2" onclick="joinRoom()">Raum beitreten</button>
    <hr />
    <label class="form-label mt-2">Anzahl Werw√∂lfe:</label>
    <select id="wolves" class="form-select">
        <option>1</option><option>2</option><option>3</option>
    </select>
    <label class="form-label mt-2">Max Spielerzahl:</label>
    <select id="maxPlayers" class="form-select">
        <option>5</option><option>6</option><option>7</option><option>8</option>
        <option>9</option><option>10</option><option>11</option><option>12</option>
        <option>13</option><option>14</option><option>15</option>
    </select>
    <button class="btn btn-success mt-2" onclick="createRoom()">Raum erstellen</button>

    <div class="mt-4">
        <h5>Verf√ºgbare R√§ume:</h5>
        <div id="availableRooms" class="mt-2">
            <div class="text-center py-2">
                <div class="spinner-border spinner-border-sm" role="status">
                    <span class="visually-hidden">Lade R√§ume...</span>
                </div>
                <span class="ms-2">Lade R√§ume...</span>
            </div>
        </div>
    </div>
</div>

<div id="game" class="card p-3 shadow-sm mt-3">
    <h3 id="waitingMessage">Warte auf Mitspieler...</h3>
    <p id="playerList"></p>
    <div class="progress mt-2">
        <div id="playerProgress" class="progress-bar" role="progressbar" style="width: 0%"></div>
    </div>
</div>

<div id="roleDisplay" class="card p-3 shadow-sm mt-3 text-center">
    <h3>Deine Rolle:</h3>
    <h2 id="roleText" class="fw-bold"></h2>
    <p id="roleDescription" class="mt-3"></p>
</div>

<div id="nightPhase" class="card p-3 shadow-sm mt-3 text-center">
    <h3 class="mb-4">Das Dorf schl√§ft ein...</h3>
    <!-- F√ºr Werw√∂lfe -->
    <div id="wolfVote" style="display: none;">
        <h4 class="text-danger mb-3">W√§hle dein Opfer:</h4>
        <div id="wolfVoteButtons" class="d-grid gap-2"></div>
        <p class="mt-3 fst-italic">Ihr m√ºsst euch auf ein Opfer einigen.</p>
    </div>
    <!-- F√ºr Dorfbewohner -->
    <div id="villagerNight">
        <p class="mb-4">Schlie√üe deine Augen und warte...</p>
        <div class="d-flex justify-content-center">
            <div class="spinner-border text-light" role="status">
                <span class="visually-hidden">Warten...</span>
            </div>
        </div>
    </div>
</div>

<div id="deathAnnouncement" class="card p-3 shadow-sm mt-3 text-center">
    <h3 id="deathText" class="animate-text">Gestorben ist...</h3>
    <h2 id="victimName" class="fw-bold animate-text mt-3"></h2>
</div>

<div id="dayPhase" class="card p-3 shadow-sm mt-3">
    <h3 class="text-center mb-4">Wer ist der Werwolf?</h3>
    <div id="dayVoteButtons" class="d-grid gap-2"></div>
    <button id="skipVoteBtn" class="btn btn-secondary skip-vote-btn">Abstimmung √ºberspringen</button>
    <div class="mt-3 text-center">
        <div id="votingTimer" class="badge bg-primary mb-2">Abstimmung: 60s</div>
        <button id="confirmVote" class="btn btn-danger" disabled>Stimme abgeben</button>
    </div>
</div>

<div id="ripScreen" class="card shadow-sm">
    <div class="rip-icon">‚ö∞Ô∏è</div>
    <h2>R.I.P.</h2>
    <p class="lead">Du bist leider tot.</p>
    <p class="mt-3">Du kannst das Spiel weiterhin verfolgen, aber nicht mehr teilnehmen.</p>
    <p class="text-danger mt-3">Tote k√∂nnen nicht mehr zur√ºckkehren...</p>

    <!-- Chat f√ºr tote Spieler -->
    <div class="mt-4">
        <h4>Geisterfl√ºstern</h4>
        <p class="text-muted small">Nur andere tote Spieler k√∂nnen dich h√∂ren...</p>
        <div id="deadChat"></div>
        <div class="chat-input">
            <input type="text" id="chatInput" class="form-control" placeholder="Nachricht schreiben..." />
            <button class="btn btn-outline-light ms-2" onclick="sendDeadChat()">‚Üë</button>
        </div>
    </div>
</div>

<div id="winAnimation"></div>

<div id="versionInfo">
    v1.2.0 <span class="toggle-details" onclick="toggleVersionDetails()">Details anzeigen</span>
    <div id="versionDetails">
        <p><strong>v1.2.0</strong> (aktuelle Version):</p>
        <ul>
            <li>Siegesbildschirme f√ºr Werw√∂lfe/Dorfbewohner korrigiert</li>
            <li>Versions-Informationen hinzugef√ºgt</li>
        </ul>
        <p><strong>v1.1.0</strong>:</p>
        <ul>
            <li>Geisterfl√ºstern f√ºr tote Spieler</li>
            <li>Skip-Button f√ºr Abstimmungen</li>
            <li>50% Mindestquote f√ºr Eliminierungen</li>
        </ul>
        <p><strong>v1.0.0</strong>:</p>
        <ul>
            <li>Grundlegendes Spiel implementiert</li>
            <li>Tag- und Nachtphasen</li>
            <li>Raumverwaltung</li>
        </ul>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const socket = io();
    let name = "", room = "";
    let myRole = "";
    let alivePlayers = [];
    let myVote = null;
    let wolfTarget = null;
    let maxPlayersInRoom = 0;
    let readyForNextGame = false;
    let amIDead = false;

    // Initialisiere Chat-Nachrichten
    let deadChatMessages = [];

    // Beim Laden verf√ºgbare R√§ume abrufen
    fetchAvailableRooms();

    // Periodisch Raumliste aktualisieren
    setInterval(fetchAvailableRooms, 5000);

    function fetchAvailableRooms() {
        socket.emit("getAvailableRooms");
    }

    socket.on("availableRooms", (rooms) => {
        const roomsContainer = document.getElementById("availableRooms");

        if (rooms.length === 0) {
            roomsContainer.innerHTML = '<p class="text-muted">Keine R√§ume verf√ºgbar</p>';
            return;
        }

        let roomsHtml = '';
        rooms.forEach(r => {
            roomsHtml += `
                <div class="room-list-item border" onclick="selectRoom('${r.id}')">
                    <div class="d-flex justify-content-between">
                        <span><b>${r.id}</b></span>
                        <span>üë• (${r.players}/${r.maxPlayers}) üê∫ [${r.wolves}]</span>
                    </div>
                </div>
            `;
        });

        roomsContainer.innerHTML = roomsHtml;
    });

    function selectRoom(roomId) {
        document.getElementById("room").value = roomId;
    }

    function createRoom() {
        name = document.getElementById("name").value;
        room = document.getElementById("room").value;
        const wolves = parseInt(document.getElementById("wolves").value);
        const maxPlayers = parseInt(document.getElementById("maxPlayers").value);
        maxPlayersInRoom = maxPlayers;

        if (!name || !room) return alert("Name und Raum-ID eingeben!");
        socket.emit("createRoom", { name, room, wolves, maxPlayers });
        document.getElementById("menu").style.display = "none";
        document.getElementById("game").style.display = "block";
        document.getElementById("gameStatus").textContent = "Lobby";
    }

    function joinRoom() {
        name = document.getElementById("name").value;
        room = document.getElementById("room").value;

        if (!name || !room) return alert("Name und Raum-ID eingeben!");
        socket.emit("joinRoom", { name, room });
        document.getElementById("menu").style.display = "none";
        document.getElementById("game").style.display = "block";
        document.getElementById("gameStatus").textContent = "Lobby";
    }

    socket.on("roomInfo", (roomInfo) => {
        maxPlayersInRoom = roomInfo.maxPlayers;
        updateWaitingMessage(roomInfo.players.length);
    });

    socket.on("updatePlayerList", (players) => {
        const playerList = document.getElementById("playerList");
        playerList.textContent = players.map(p => p.name).join(", ");

        // Spielerliste f√ºr sp√§tere Verwendung speichern
        alivePlayers = players;

        // Wartenachricht und Fortschrittsbalken aktualisieren
        updateWaitingMessage(players.length);
        const progress = (players.length / maxPlayersInRoom) * 100;
        document.getElementById("playerProgress").style.width = `${progress}%`;
    });

    function updateWaitingMessage(currentPlayers) {
        const waitingMessage = document.getElementById("waitingMessage");
        const playersNeeded = maxPlayersInRoom - currentPlayers;

        if (playersNeeded > 0) {
            waitingMessage.textContent = `Warte auf ${playersNeeded} weitere Spieler...`;
        } else if (readyForNextGame) {
            waitingMessage.textContent = `Bereit f√ºr n√§chste Runde...`;
        } else {
            waitingMessage.textContent = `Spiel startet in K√ºrze!`;
        }
    }

    // Animierte Rollenzuweisung
    socket.on("showRole", (role) => {
        // Alle Ansichten verstecken, au√üer RIP-Bildschirm falls tot
        if (amIDead) return;

        document.getElementById("game").style.display = "none";
        document.getElementById("roleDisplay").style.display = "block";
        document.getElementById("gameStatus").textContent = "Rollenverteilung";
        readyForNextGame = false;

        const roleText = document.getElementById("roleText");
        roleText.textContent = "";
        roleText.className = "fw-bold animate-text";
        myRole = role;

        // Animation: "Du..." -> "Du... bist..." -> "Du... bist... [Rolle]"
        let steps = [
            "Du...",
            "Du... bist...",
            `Du... bist... ${role === "Werwolf" ? "Werwolf" : "Dorfbewohner"}`
        ];
        let i = 0;
        function showStep() {
            roleText.textContent = steps[i];
            roleText.classList.add("visible");
            setRoleColor(role);
            if (i < steps.length - 1) {
                setTimeout(() => {
                    roleText.classList.remove("visible");
                    setTimeout(() => {
                        i++;
                        showStep();
                    }, 300);
                }, 1000);
            } else {
                // Nach Animation: Rolle dauerhaft anzeigen
                setTimeout(() => {
                    roleText.textContent = role;
                    setRoleColor(role);
                    roleText.className = "fw-bold";

                    // Rollenbeschreibung anzeigen
                    const desc = document.getElementById("roleDescription");
                    if (role === "Werwolf") {
                        desc.textContent = "Deine Aufgabe: W√§hle nachts mit den anderen Werw√∂lfen ein Opfer. Verberge tags√ºber deine Identit√§t.";
                    } else {
                        desc.textContent = "Deine Aufgabe: Finde heraus, wer die Werw√∂lfe sind und stimme bei Tag gegen sie ab.";
                    }
                }, 1000);
            }
        }
        showStep();
    });

    function setRoleColor(role) {
        const roleText = document.getElementById('roleText');
        if (role === "Werwolf") {
            roleText.classList.add("role-wolf");
            roleText.classList.remove("role-villager");
        } else {
            roleText.classList.add("role-villager");
            roleText.classList.remove("role-wolf");
        }
    }

    // Nachtphase starten
    socket.on("startNight", () => {
        // Tote Spieler sehen nur den RIP-Bildschirm
        if (amIDead) return;

        document.getElementById("roleDisplay").style.display = "none";
        document.getElementById("dayPhase").style.display = "none";
        document.getElementById("nightPhase").style.display = "block";
        document.getElementById("gameStatus").textContent = "Nacht";
        document.body.classList.add("night-phase");
        document.body.classList.remove("day-phase");

        // Werwolf-Voting vorbereiten
        if (myRole === "Werwolf") {
            document.getElementById("wolfVote").style.display = "block";
            document.getElementById("villagerNight").style.display = "none";

            // Voting-Buttons erstellen
            const wolfVoteButtons = document.getElementById("wolfVoteButtons");
            wolfVoteButtons.innerHTML = "";

            // Nur lebende Dorfbewohner als potenzielle Opfer anzeigen
            const livingVictims = alivePlayers.filter(player =>
                player.id !== socket.id && // Sich selbst nicht anzeigen
                player.role !== "Werwolf" &&
                player.alive);

            if (livingVictims.length === 0) {
                wolfVoteButtons.innerHTML = `
                    <div class="alert alert-warning">
                        Keine Dorfbewohner mehr √ºbrig!
                    </div>`;
            } else {
                livingVictims.forEach(player => {
                    const btn = document.createElement("button");
                    btn.className = "btn btn-outline-light vote-btn wolf-target-btn";
                    btn.textContent = player.name;
                    btn.dataset.player = player.id;
                    btn.onclick = function() {
                        // Alle Buttons zur√ºcksetzen
                        document.querySelectorAll(".vote-btn").forEach(b =>
                            b.classList.remove("selected"));
                        // Diesen Button ausw√§hlen
                        this.classList.add("selected");
                        // Vote an Server senden
                        wolfTarget = player.id;
                        socket.emit("wolfVote", { room, target: player.id });
                    };
                    wolfVoteButtons.appendChild(btn);
                });
            }
        } else {
            document.getElementById("wolfVote").style.display = "none";
            document.getElementById("villagerNight").style.display = "block";
        }
    });

    // Werwolf-Votes aktualisieren (f√ºr alle Werw√∂lfe)
    socket.on("updateWolfVotes", (votes) => {
        if (myRole !== "Werwolf" || amIDead) return;

        // Alle Buttons zur√ºcksetzen
        document.querySelectorAll(".vote-btn").forEach(btn =>
            btn.classList.remove("targeted"));

        // Anzeigen, welche Spieler von anderen Werw√∂lfen anvisiert werden
        for (const [wolfId, targetId] of Object.entries(votes)) {
            if (wolfId !== socket.id) { // Nicht meine eigene Stimme
                const targetBtn = document.querySelector(`.vote-btn[data-player="${targetId}"]`);
                if (targetBtn) targetBtn.classList.add("targeted");
            }
        }
    });

    // Tod-Ank√ºndigung
    socket.on("announceVictim", (victim) => {
        // Auch tote Spieler sehen die Ank√ºndigung, k√∂nnen aber nicht mehr abstimmen
        if (amIDead) return;

        document.getElementById("nightPhase").style.display = "none";
        document.getElementById("deathAnnouncement").style.display = "block";
        document.getElementById("gameStatus").textContent = "Morgengrauen";

        const deathText = document.getElementById("deathText");
        const victimName = document.getElementById("victimName");

        deathText.textContent = "Gestorben ist...";
        victimName.textContent = "";
        deathText.classList.add("visible");
        victimName.classList.remove("visible");

        // Nach einer Sekunde den Namen anzeigen
        setTimeout(() => {
            victimName.textContent = victim.name;
            victimName.classList.add("visible");

            // Nach weiteren 3 Sekunden zur Tagphase √ºbergehen
            setTimeout(() => {
                // Wenn ich das Opfer bin, zeige RIP-Bildschirm
                if (victim.id === socket.id) {
                    showRipScreen();
                } else {
                    socket.emit("readyForDay", { room });
                }
            }, 3000);
        }, 1000);
    });

    // RIP-Bildschirm anzeigen f√ºr tote Spieler
    function showRipScreen() {
        // Alle Spielansichten ausblenden
        document.querySelectorAll("#game, #roleDisplay, #nightPhase, #dayPhase, #deathAnnouncement").forEach(el => {
            el.style.display = "none";
        });

        // RIP-Bildschirm anzeigen
        document.getElementById("ripScreen").style.display = "block";
        document.getElementById("gameStatus").textContent = "Verstorben";
        amIDead = true;

        // Toten-Chat initialisieren
        document.getElementById("deadChat").innerHTML = "";

        // Chat-Event-Listener hinzuf√ºgen (nur einmal)
        if (!document.getElementById("chatInput").hasAttribute("data-listener-added")) {
            document.getElementById("chatInput").addEventListener("keyup", function(event) {
                if (event.key === "Enter") {
                    sendDeadChat();
                }
            });
            document.getElementById("chatInput").setAttribute("data-listener-added", "true");
        }
    }

    // Chat-Nachricht senden
    function sendDeadChat() {
        const input = document.getElementById("chatInput");
        const message = input.value.trim();

        if (message) {
            socket.emit("deadChat", { room, name, message });
            input.value = "";

            // Keine lokale Nachricht mehr hinzuf√ºgen, um Duplikate zu vermeiden
            // Die Nachricht kommt vom Server zur√ºck
        }
    }

    // Chat aktualisieren
    function updateDeadChat() {
        const chatContainer = document.getElementById("deadChat");
        let chatHtml = "";

        if (deadChatMessages.length === 0) {
            chatHtml = '<div class="text-muted">Noch keine Nachrichten. Sei der Erste, der ins Jenseits spricht!</div>';
        } else {
            deadChatMessages.forEach(msg => {
                const isMe = msg.senderId === socket.id ? 'text-info' : '';
                chatHtml += `
                    <div class="chat-message">
                        <span class="sender ${isMe}">${msg.name}:</span> ${msg.message}
                    </div>
                `;
            });
        }

        chatContainer.innerHTML = chatHtml;
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // Neue Chat-Nachricht erhalten
    socket.on("deadChatMessage", (msg) => {
        // Nur Nachrichten empfangen, wenn man tot ist
        if (!amIDead) return;

        deadChatMessages.push(msg);
        updateDeadChat();
    });

    // Tagphase starten
    socket.on("startDay", (data) => {
        // Tote Spieler sehen nur den RIP-Bildschirm
        if (amIDead) return;

        document.getElementById("deathAnnouncement").style.display = "none";
        document.getElementById("dayPhase").style.display = "block";
        document.getElementById("gameStatus").textContent = "Tag";
        document.body.classList.remove("night-phase");
        document.body.classList.add("day-phase");

        // Abstimmungs-Status zur√ºcksetzen
        myVote = null;
        document.getElementById("confirmVote").disabled = true;
        document.getElementById("confirmVote").textContent = "Stimme abgeben";
        document.getElementById("skipVoteBtn").classList.remove("selected");
        document.getElementById("skipVoteBtn").disabled = false;

        // Voting-Buttons erstellen
        const dayVoteButtons = document.getElementById("dayVoteButtons");
        dayVoteButtons.innerHTML = "";

        // Aktualisierte Spielerliste vom Server √ºbernehmen
        if (data && data.alivePlayers) {
            console.log("Erhaltene Spielerliste:", data.alivePlayers);
            // Nur die alivePlayers mit den vom Server empfangenen Daten aktualisieren
            alivePlayers = data.alivePlayers;
        }

        // Nur lebende Spieler anzeigen, die nicht ich selbst sind
        const livingPlayers = alivePlayers.filter(player =>
            player.id !== socket.id && // Sich selbst ausschlie√üen
            player.alive === true);  // Explizit auf true pr√ºfen

        console.log("Gefilterte lebende Spieler:", livingPlayers);

        if (livingPlayers.length <= 1) {
            dayVoteButtons.innerHTML = `
                <div class="alert alert-warning">
                    Nicht gen√ºgend Spieler f√ºr eine Abstimmung.
                </div>`;
            document.getElementById("skipVoteBtn").click(); // Automatisch Skip w√§hlen
        } else {
            livingPlayers.forEach(player => {
                const btn = document.createElement("button");
                btn.className = "btn btn-outline-dark vote-btn";
                btn.textContent = player.name;
                btn.dataset.player = player.id;
                btn.onclick = function() {
                    // Alle Buttons zur√ºcksetzen
                    document.querySelectorAll(".vote-btn").forEach(b =>
                        b.classList.remove("selected"));
                    document.getElementById("skipVoteBtn").classList.remove("selected");
                    // Diesen Button ausw√§hlen
                    this.classList.add("selected");
                    // Vote speichern
                    myVote = player.id;
                    // Abstimm-Button aktivieren
                    document.getElementById("confirmVote").disabled = false;
                };
                dayVoteButtons.appendChild(btn);
            });
        }

        // Skip-Button f√ºr Abstimmung
        document.getElementById("skipVoteBtn").onclick = function() {
            // Alle Buttons zur√ºcksetzen
            document.querySelectorAll(".vote-btn").forEach(b =>
                b.classList.remove("selected"));
            // Skip als Vote speichern
            myVote = "skip";
            // Abstimm-Button aktivieren
            document.getElementById("confirmVote").disabled = false;
            // Diesen Button hervorheben
            this.classList.add("selected");
        };

        // Abstimm-Button
        document.getElementById("confirmVote").onclick = function() {
            if (myVote) {
                socket.emit("dayVote", { room, target: myVote });
                this.disabled = true;
                this.textContent = "Stimme abgegeben";
                dayVoteButtons.querySelectorAll("button").forEach(btn => {
                    btn.disabled = true;
                });
                document.getElementById("skipVoteBtn").disabled = true;
            }
        };

        // Timer starten
        let timeLeft = 60;
        const timerElement = document.getElementById("votingTimer");
        const timer = setInterval(() => {
            timeLeft--;
            timerElement.textContent = `Abstimmung: ${timeLeft}s`;
            if (timeLeft <= 0) {
                clearInterval(timer);
                timerElement.textContent = "Abstimmung beendet";
                // Automatisch abstimmen, falls noch nicht getan
                if (!document.getElementById("confirmVote").disabled) {
                    // Automatisch Skip w√§hlen, wenn keine Auswahl getroffen wurde
                    if (!myVote) {
                        myVote = "skip";
                    }
                    document.getElementById("confirmVote").click();
                }
            }
        }, 1000);
    });

    // Niemand wurde get√∂tet Benachrichtigung
    socket.on("noElimination", () => {
        // Auch f√ºr tote Spieler anzeigen
        document.getElementById("nightPhase").style.display = "none";
        document.getElementById("dayPhase").style.display = "none";

        if (!amIDead) {
            document.getElementById("deathAnnouncement").style.display = "block";
        }

        document.getElementById("gameStatus").textContent = "Abstimmungsergebnis";

        const deathText = document.getElementById("deathText");
        const victimName = document.getElementById("victimName");

        deathText.textContent = "Das Ergebnis...";
        victimName.textContent = "";
        deathText.classList.add("visible");
        victimName.classList.remove("visible");

        // Nach einer Sekunde die Nachricht anzeigen
        setTimeout(() => {
            victimName.textContent = "Heute ist niemand gestorben...";
            victimName.classList.add("visible");

            // Nach weiteren 3 Sekunden weitergehen
            setTimeout(() => {
                if (!amIDead) {
                    socket.emit("readyForNight", { room });
                }
            }, 3000);
        }, 1000);
    });

    // Spielende - Event-Handler korrigiert (doppelter Code entfernt)
    socket.on("gameOver", (result) => {
        console.log("SPIEL BEENDET mit Gewinner:", result.winner);

        // Stoppe alle laufenden Timer
        for (let id in window) {
            if (!isNaN(parseInt(id)) && window.hasOwnProperty(id)) {
                clearTimeout(id);
                clearInterval(id);
            }
        }

        // Alle UI-Elemente ausblenden, auch den RIP-Screen
        document.querySelectorAll("#nightPhase, #dayPhase, #deathAnnouncement, #ripScreen").forEach(el => {
            el.style.display = "none";
        });

        document.getElementById("gameStatus").textContent = "Spiel beendet - " + result.winner + " gewinnen";

        // Sieganimation anzeigen (Blut oder Konfetti)
        playWinAnimation(result.winner);

        // Nach Animation Spielergebnisse anzeigen
        setTimeout(() => {
            const gameDiv = document.getElementById("game");
            gameDiv.style.display = "block";

            gameDiv.innerHTML = `
                <div class="result-card card">
                    <div class="card-header bg-${result.winner === "Werw√∂lfe" ? "danger" : "primary"} text-white">
                        <h2 class="text-center m-0">${result.winner} haben gewonnen!</h2>
                    </div>
                    <div class="card-body p-3">
                        <h4 class="mb-3">Spieler:</h4>
                        <ul class="list-group">
                            ${result.players.map(p => {
                                const hasWon = (p.role === "Werwolf" && result.winner === "Werw√∂lfe") ||
                                    (p.role === "Dorfbewohner" && result.winner === "Dorfbewohner");
                                const roleClass = p.role === "Werwolf" ? "player-role-wolf" : "player-role-villager";
                                return `
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <div>
                                            ${p.name}
                                            <span class="result-badge ${hasWon ? 'win-badge' : 'loss-badge'}">${hasWon ? 'W' : 'L'}</span>
                                        </div>
                                        <div>
                                            <span class="badge ${roleClass}">${p.role}</span>
                                            ${p.alive ? '' : '<span class="badge player-status-dead ms-1">‚ò†Ô∏è Tot</span>'}
                                        </div>
                                    </li>`;
                            }).join('')}
                        </ul>
                        <div class="text-center mt-3 small text-muted">
                            <p>W = Gewonnen | L = Verloren</p>
                        </div>
                    </div>
                    <div class="card-footer bg-light">
                        <div class="d-flex justify-content-between">
                            <button id="readyButton" class="btn ready-button flex-grow-1 me-2" onclick="playAgain()">
                                <i class="bi bi-check-circle"></i> Bereit f√ºr n√§chste Runde
                            </button>
                            <button class="btn btn-secondary flex-grow-1" onclick="location.reload()">
                                Neues Spiel starten
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // Bei toten Spielern Hinweis anzeigen aber Button nicht deaktivieren
            if (amIDead) {
                document.getElementById("readyButton").classList.add("btn-outline-secondary");
                document.getElementById("readyButton").classList.remove("ready-button");
                document.getElementById("readyButton").innerHTML = '<i class="bi bi-ghost"></i> Als Geist teilnehmen';
            }
        }, 3500);
    });

    function playAgain() {
        // Tote und lebende Spieler k√∂nnen teilnehmen
        readyForNextGame = true;
        socket.emit("playAgain", { room, name });

        // Button-Zustand √§ndern
        const readyButton = document.getElementById("readyButton");
        readyButton.classList.add("active");
        readyButton.innerHTML = '<i class="bi bi-check-circle-fill"></i> Bereit!';
        readyButton.disabled = true;

        // Wartebereich anzeigen
        const gameDiv = document.getElementById("game");
        gameDiv.innerHTML = `
            <div class="alert alert-success">
                <h4 class="mb-3">Warte auf weitere Spieler in Raum: ${room}</h4>
                <h5 id="waitingMessage">Bereit f√ºr n√§chste Runde...</h5>
                <p id="playerList"></p>
                <div class="progress mt-2">
                    <div id="playerProgress" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
                </div>
                <button class="btn btn-outline-danger mt-3" onclick="location.reload()">Spiel verlassen</button>
            </div>
        `;
        document.getElementById("gameStatus").textContent = "Warte in Lobby";
    }

    // Versionsinfo aktualisieren
    document.getElementById('versionInfo').innerHTML = `
        v1.7.0 <span class="toggle-details" onclick="toggleVersionDetails()">Details anzeigen</span>
        <div id="versionDetails">
            <p><strong>v1.7.0</strong> (aktuelle Version):</p>
            <ul>
                <li>Endkarte f√ºr alle Spieler sichtbar</li>
                <li>Spieler k√∂nnen nach Spielende an neuer Runde teilnehmen</li>
                <li>Fehlerbehebung beim √úbergang zum Spielende</li>
            </ul>
            <p><strong>v1.6.0</strong>:</p>
            <ul>
                <li>Siegesanimationen und Endkarte f√ºr alle Spieler</li>
                <li>Konfetti-Animation f√ºr Dorfbewohner-Sieg</li>
                <li>Blut-Animation f√ºr Werwolf-Sieg</li>
            </ul>
            <p><strong>v1.5.0</strong>:</p>
            <ul>
                <li>Bugfixes f√ºr Spielende</li>
                <li>Doppelte Eventhandler beseitigt</li>
            </ul>
        </div>
    `;

    // Versions-Details ein-/ausblenden
    function toggleVersionDetails() {
        const details = document.getElementById('versionDetails');
        const toggle = document.querySelector('.toggle-details');
        if (details.style.display === 'block') {
            details.style.display = 'none';
            toggle.textContent = 'Details anzeigen';
        } else {
            details.style.display = 'block';
            toggle.textContent = 'Details ausblenden';
        }
    }
</script>
</body>
</html>
